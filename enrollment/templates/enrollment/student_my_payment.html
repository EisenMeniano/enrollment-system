{% extends "base.html" %}
{% block title %}My Payment{% endblock %}
{% block content %}
<div class="layout">
  {% include "enrollment/_student_sidebar.html" with active="my_payment" %}
  <section>
    {% include "enrollment/_student_topinfo.html" %}
    <div class="section-card">
      <h3 class="section-title">My Payment</h3>
      <style>
        .pay-toolbar {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          align-items: end;
          margin-bottom: 10px;
        }
        .pay-toolbar .pay-field {
          width: 100%;
        }
        .pay-actions {
          display: inline-flex;
          gap: 8px;
          justify-content: flex-end;
          margin: 6px 0 16px;
        }
        .pay-field label {
          display: block;
          font-weight: 700;
          color: #263238;
          margin-bottom: 6px;
        }
        .pay-field label .req {
          color: #d32f2f;
          margin-right: 4px;
        }
        .pay-field select,
        .pay-field input {
          width: 100%;
          border: 1px solid #cfd8dc;
          border-radius: 6px;
          padding: 8px 10px;
          background: #fff;
        }
        .pay-actions .btn {
          padding: 6px 12px;
        }
        .section-subtitle {
          font-weight: 700;
          color: #37474f;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          margin: 18px 0 10px;
        }
        .section-subtitle::before {
          content: "";
          width: 3px;
          height: 16px;
          background: #2e7d32;
          display: inline-block;
        }
        .fees-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 18px;
          table-layout: fixed;
        }
        .fees-table th:first-child,
        .fees-table td:first-child {
          width: 70%;
        }
        .fees-table th.amount,
        .fees-table td.amount {
          width: 30%;
        }
        .fees-table .net-row td:first-child {
          text-align: left;
        }
        .fees-table .net-row td {
          border-bottom: 0;
        }
        .fees-table .net-row td.amount {
          border-left: 0;
          text-align: right;
        }
        .fees-table th,
        .fees-table td {
          border: 1px solid #e0e0e0;
          padding: 10px;
          text-align: left;
        }
        .fees-table thead th {
          background: #f3f7ff;
          color: #455a64;
          font-weight: 700;
        }
        .fees-table .amount {
          text-align: right;
          white-space: nowrap;
        }
        .pay-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin: 14px 0 6px;
        }
        .pay-card {
          border: 1px solid #e0e0e0;
          border-radius: 10px;
          padding: 16px 18px;
          background: #fff;
          box-shadow: 0 8px 24px rgba(16, 24, 40, 0.08);
        }
        .pay-card h4 {
          margin: 0 0 12px;
          font-size: 15px;
          font-weight: 700;
          color: #2f3b45;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }
        .pay-card h4::before {
          content: "";
          width: 3px;
          height: 18px;
          background: #2e7d32;
          display: inline-block;
        }
        .pay-card .amount-box {
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 12px 14px;
          display: grid;
          grid-template-columns: 1fr auto;
          align-items: center;
          font-weight: 700;
          color: #263238;
          background: #fff;
        }
        .pay-card .amount-box .amount-value {
          color: #1565c0;
        }
        .pay-card .pay-action {
          text-align: right;
          margin-top: 12px;
        }
        .pay-card .pay-action .btn {
          padding: 6px 14px;
          border-radius: 999px;
        }
        .pay-card .pay-action .btn.disabled {
          pointer-events: none;
          opacity: 0.6;
        }
        .pay-online {
          display: inline-block;
          border: 1px solid #29b6f6;
          color: #29b6f6;
          padding: 6px 12px;
          border-radius: 6px;
          background: #fff;
          font-weight: 700;
        }
        .receipts-table {
          width: 100%;
          border-collapse: collapse;
        }
        .receipts-table th,
        .receipts-table td {
          border: 1px solid #e0e0e0;
          padding: 8px 10px;
          text-align: left;
          font-size: 13px;
        }
        .receipts-table thead th {
          background: #f3f7ff;
          color: #455a64;
          font-weight: 700;
        }
        .status-complete {
          color: #2e7d32;
          font-weight: 700;
        }
        @media (max-width: 900px) {
          .pay-toolbar {
            grid-template-columns: 1fr;
          }
          .pay-row {
            grid-template-columns: 1fr;
          }
        }
      </style>

      <div class="section-subtitle">Flow Guidance</div>
      <div class="subtle" style="margin-bottom:12px;">
        1. Down Payment page is for enlistment downpayment only.
        2. My Payment opens after adviser final approval and finance sets tuition.
        3. Enrollment tuition can be paid by full or per term (Prelim/Midterm/Final).
        {% if latest_enlistment %}
          <br>Current enlistment status: <strong>{{ latest_enlistment.get_status_display }}</strong>.
        {% endif %}
        {% if my_payment_message %}
          <br><strong>{{ my_payment_message }}</strong>
        {% endif %}
      </div>

      <div class="pay-toolbar">
        <div class="pay-field">
          <label><span class="req">*</span>Payment Type</label>
          <select id="paymentType" {% if not my_payment_enabled %}disabled{% endif %}>
            <option value="">Please Select</option>
            <option value="FULL">Full Payment</option>
            <option value="INSTALLMENT">Installment</option>
          </select>
        </div>
        <div class="pay-field">
          <label><span class="req">*</span>Term</label>
          <select id="paymentSemester" {% if not my_payment_enabled %}disabled{% endif %}>
            <option value="">Please Select</option>
            <option value="PRELIM">Prelim (1st Term)</option>
            <option value="MIDTERM">Midterm (2nd Term)</option>
            <option value="FINAL">Final (3rd Term)</option>
          </select>
        </div>
        <div class="pay-actions">
          <button class="btn" id="btnShowPayment" type="button" {% if not my_payment_enabled %}disabled{% endif %}>Show</button>
          <button class="btn secondary" id="btnClearPayment" type="button" {% if not my_payment_enabled %}disabled{% endif %}>Clear</button>
        </div>
      </div>

      <div class="section-subtitle">Fees Details</div>
      <table class="fees-table">
        <thead>
          <tr>
            <th>Payment Type</th>
            <th class="amount">Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr data-fee="installment">
            <td>Prelim (1st Term)</td>
            <td class="amount">{{ payment_breakdown.prelim|floatformat:2 }}</td>
          </tr>
          <tr data-fee="installment">
            <td>Midterm (2nd Term)</td>
            <td class="amount">{{ payment_breakdown.midterm|floatformat:2 }}</td>
          </tr>
          <tr data-fee="installment">
            <td>Final (3rd Term)</td>
            <td class="amount">{{ payment_breakdown.final|floatformat:2 }}</td>
          </tr>
          <tr data-fee="installment">
            <td>Tuition Balance</td>
            <td class="amount">{{ payment_breakdown.total|floatformat:2 }}</td>
          </tr>
          <tr data-fee="full">
            <td>FULL PAYMENT</td>
            <td class="amount">{{ payment_breakdown.total|floatformat:2 }}</td>
          </tr>
          <tr>
            <td style="font-weight:700;">Total Amount</td>
            <td class="amount" style="font-weight:700;">{{ payment_breakdown.total|floatformat:2 }}</td>
          </tr>
        </tbody>
      </table>

      <div
        class="pay-row"
        id="paymentActions"
        data-total="{{ payment_breakdown.total|floatformat:2 }}"
        data-prelim="{{ payment_breakdown.prelim|floatformat:2 }}"
        data-midterm="{{ payment_breakdown.midterm|floatformat:2 }}"
        data-final="{{ payment_breakdown.final|floatformat:2 }}"
        data-enabled="{% if my_payment_enabled %}1{% else %}0{% endif %}"
        data-pay-url="{% if latest_enlistment %}{% url 'enrollment:student_pay' latest_enlistment.id %}{% endif %}"
      >
        <div class="pay-card">
          <h4>Pay In Cash</h4>
          <div class="amount-box">
            <span>Amount :</span>
            <span class="amount-value" id="cashAmount">0.00</span>
          </div>
          <div class="pay-action">
            <a class="btn disabled" id="btnPayCash" href="#" aria-disabled="true">Pay In Cash</a>
          </div>
        </div>
        <div class="pay-card">
          <h4>Pay Online</h4>
          <div class="amount-box">
            <span>Amount :</span>
            <span class="amount-value" id="onlineAmount">0.00</span>
          </div>
          <div class="pay-action">
            <a class="btn disabled" id="btnPayOnline" href="#" aria-disabled="true">Pay Online</a>
          </div>
        </div>
      </div>
      <p class="subtle" id="paymentActionNote">
        {% if my_payment_enabled %}
          Select payment type and term, then click Show to enable payment actions.
        {% else %}
          {{ my_payment_message }}
        {% endif %}
      </p>

      <p class="verify-note">Dear {{ user.first_name|default:"Student" }} {{ user.last_name|default:"" }}, Your payment is verified.</p>

      <div class="section-subtitle">Previous Receipts Information</div>
      <table class="receipts-table">
        <thead>
          <tr>
            <th>Sr.No.</th>
            <th>Receipt Type</th>
            <th>Receipt No</th>
            <th>Order Id</th>
            <th>Date</th>
            <th>Semester</th>
            <th>Pay Type</th>
            <th>Amount</th>
            <th>Payment Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>ENROLLMENT</td>
            <td>--</td>
            <td>--</td>
            <td>--</td>
            <td>
              {% if latest_enlistment %}
                {{ latest_enlistment.semester }}
              {% else %}
                ---
              {% endif %}
            </td>
            <td>CASH</td>
            <td>
              {% if payment_breakdown %}
                {{ payment_breakdown.total|floatformat:2 }}
              {% else %}
                0.00
              {% endif %}
            </td>
            <td class="status-complete">COMPLETE</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>
<script>
  (function () {
    var showBtn = document.getElementById("btnShowPayment");
    var clearBtn = document.getElementById("btnClearPayment");
    var typeSelect = document.getElementById("paymentType");
    var semesterSelect = document.getElementById("paymentSemester");
    var feeRows = document.querySelectorAll("[data-fee]");
    var paymentActions = document.getElementById("paymentActions");
    var pageEnabled = paymentActions.getAttribute("data-enabled") === "1";
    var payUrl = paymentActions.getAttribute("data-pay-url");
    var cashAmountEl = document.getElementById("cashAmount");
    var onlineAmountEl = document.getElementById("onlineAmount");
    var payCashBtn = document.getElementById("btnPayCash");
    var payOnlineBtn = document.getElementById("btnPayOnline");
    var paymentActionNote = document.getElementById("paymentActionNote");
    var amounts = {
      total: parseFloat(paymentActions.getAttribute("data-total") || "0"),
      prelim: parseFloat(paymentActions.getAttribute("data-prelim") || "0"),
      midterm: parseFloat(paymentActions.getAttribute("data-midterm") || "0"),
      final: parseFloat(paymentActions.getAttribute("data-final") || "0")
    };

    function formatAmount(value) {
      return Number(value || 0).toFixed(2);
    }

    function setFeeVisibility(mode) {
      feeRows.forEach(function (row) {
        var feeType = row.getAttribute("data-fee");
        if (!mode) {
          row.style.display = "";
          return;
        }
        row.style.display = feeType === mode ? "" : "none";
      });
    }

    function getSelectedAmount() {
      if (typeSelect.value === "FULL") {
        return amounts.total;
      }
      if (semesterSelect.value === "PRELIM") {
        return amounts.prelim;
      }
      if (semesterSelect.value === "MIDTERM") {
        return amounts.midterm;
      }
      if (semesterSelect.value === "FINAL") {
        return amounts.final;
      }
      return null;
    }

    function setActionState(enabled, amount, term) {
      cashAmountEl.textContent = formatAmount(amount);
      onlineAmountEl.textContent = formatAmount(amount);
      if (!enabled) {
        payCashBtn.classList.add("disabled");
        payOnlineBtn.classList.add("disabled");
        payCashBtn.setAttribute("aria-disabled", "true");
        payOnlineBtn.setAttribute("aria-disabled", "true");
        payCashBtn.href = "#";
        payOnlineBtn.href = "#";
        return;
      }

      var referenceSuffix = typeSelect.value === "FULL" ? "FULL" : ("INSTALLMENT-" + term);
      payCashBtn.classList.remove("disabled");
      payOnlineBtn.classList.remove("disabled");
      payCashBtn.setAttribute("aria-disabled", "false");
      payOnlineBtn.setAttribute("aria-disabled", "false");
      payCashBtn.href = payUrl + "?fee_kind=TUITION&amount=" + encodeURIComponent(formatAmount(amount)) + "&reference=" + encodeURIComponent("CASH-" + referenceSuffix);
      payOnlineBtn.href = payUrl + "?fee_kind=TUITION&amount=" + encodeURIComponent(formatAmount(amount)) + "&reference=" + encodeURIComponent("ONLINE-" + referenceSuffix);
    }

    function showResults() {
      if (!typeSelect.value) {
        return;
      }
      if (!pageEnabled) {
        return;
      }
      if (typeSelect.value === "INSTALLMENT" && !semesterSelect.value) {
        return;
      }
      var amount = getSelectedAmount();
      var hasPayFlow = !!payUrl;
      var canEnable = hasPayFlow && amount !== null && amount > 0;
      setFeeVisibility(typeSelect.value === "FULL" ? "full" : "installment");
      setActionState(canEnable, amount, semesterSelect.value);
      if (!hasPayFlow) {
        paymentActionNote.textContent = "No enlistment available for payment.";
      } else if (!canEnable) {
        paymentActionNote.textContent = "Selected amount is 0.00. Nothing to pay for this option.";
      } else {
        paymentActionNote.textContent = "Payment actions are enabled. Choose cash or online to continue.";
      }
    }

    function clearResults() {
      typeSelect.value = "";
      semesterSelect.value = "";
      setFeeVisibility(null);
      setActionState(false, 0, "");
      if (pageEnabled) {
        paymentActionNote.textContent = "Select payment type and term, then click Show to enable payment actions.";
      }
    }

    clearResults();
    showBtn.addEventListener("click", showResults);
    clearBtn.addEventListener("click", clearResults);
    typeSelect.addEventListener("change", showResults);
    semesterSelect.addEventListener("change", showResults);
  })();
</script>
{% endblock %}
